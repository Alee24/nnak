<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - NNAK Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=cal-sans:wght@400;500;600&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS (CDN for reliability) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/styles.css">

    <style>
        /* Custom overrides */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e2e8f0;
            border-radius: 20px;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Event specific styles */
        .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .event-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-light);
        }

        .event-image {
            height: 160px;
            background-color: #f1f5f9;
            position: relative;
            overflow: hidden;
        }

        .event-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .event-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .event-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .event-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .create-card {
            border: 2px dashed var(--border-color);
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            cursor: pointer;
            color: var(--text-light);
            transition: 0.2s;
        }

        .create-card:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        /* Modal Overlay override */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 24px;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.15s ease-out;
        }

        .modal-box {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-gray-800 flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <div id="sidebar-container"></div>
    <script src="../js/sidebar.js"></script>


    <!-- CONTENT -->
    <main class="admin-main flex-1 flex flex-col overflow-hidden relative" style="margin-left: 0;">
        <!-- Header -->
        <header
            class="h-20 flex justify-between items-center px-8 flex-shrink-0 bg-white border-b border-gray-100 z-10 shadow-sm lg:shadow-none">
            <!-- Mobile Menu Button -->
            <button class="lg:hidden text-gray-500 hover:text-gray-700 mr-2">
                <svg data-lucide="menu" width="24"></svg>
            </button>

            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight font-dm-sans">Events Management</h1>
                <p class="text-sm text-gray-500 mt-0.5">Create and manage member events</p>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="openCreateModal()"
                    class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-green-600/20 hover:scale-[1.02] transform transition bg-[#059669] text-white">
                    <svg data-lucide="plus" width="18"></svg> <span class="hidden md:inline">Create Event</span>
                </button>
            </div>
        </header>

        <div class="content-container">

            <!-- Filters -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                <div class="relative w-full md:w-80">
                    <div
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">
                        <svg data-lucide="search" width="16"></svg>
                    </div>
                    <input type="text" id="searchInput" onkeyup="handleSearch(event)" class="form-input"
                        style="padding-left: 36px;" placeholder="Search events...">
                </div>

                <div class="segmented-control">
                    <button class="segment-btn active" onclick="filterEvents('all', this)">All</button>
                    <button class="segment-btn" onclick="filterEvents('upcoming', this)">Upcoming</button>
                    <button class="segment-btn" onclick="filterEvents('past', this)">Past</button>
                </div>
            </div>

            <!-- Events Grid -->
            <div class="event-grid" id="eventsContainer">
                <!-- Create New Card -->
                <div class="create-card rounded-2xl" onclick="openCreateModal()">
                    <div
                        style="width: 48px; height: 48px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                        <svg data-lucide="plus" width="24"></svg>
                    </div>
                    <span style="font-weight: 600;">Create New Event</span>
                </div>

                <!-- Dynamic Content Will Load Here -->
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="animate-spin"
                    style="margin: 0 auto 12px; width: 24px; height: 24px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%;">
                </div>
                <span class="text-xs text-muted">Loading events...</span>
            </div>

        </div>
    </main>

    <!-- Create Event Modal -->
    <div id="createModal" class="modal-overlay">
        <div class="modal-box">
            <div
                style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #f9fafb;">
                <h3 style="font-weight: 700; color: var(--text-main);">Create New Event</h3>
                <button onclick="closeModal()"
                    style="border: none; background: transparent; cursor: pointer; color: var(--text-muted);"><svg
                        data-lucide="x" width="20"></svg></button>
            </div>

            <div style="padding: 24px; overflow-y: auto;">
                <form id="createEventForm" onsubmit="handleCreate(event)">

                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" required class="form-input"
                            placeholder="e.g. Annual General Meeting">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Event Image</label>
                        <input type="file" name="image" accept="image/*" class="form-input" style="padding: 8px;">
                    </div>

                    <div class="flex gap-4">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Date</label>
                            <input type="date" name="date" required class="form-input">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Time</label>
                            <input type="time" name="time" required class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location / Link</label>
                        <input type="text" name="location" required class="form-input"
                            placeholder="e.g. Nairobi ICC or Zoom Link">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Event Type</label>
                        <select name="type" class="form-input">
                            <option value="Conference">Conference</option>
                            <option value="Webinar">Webinar</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Meetup">Meetup</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" rows="3" class="form-input"
                            placeholder="Brief details about the event..."></textarea>
                    </div>

                    <div style="margin-top: 32px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" onclick="closeModal()" class="btn btn-outline">Cancel</button>
                        <button type="submit" class="premium-button"
                            style="padding: 10px 24px; font-weight: 600; border-radius: 8px;">Publish Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        lucide.createIcons();

        let allEvents = [];
        let filterStatus = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
        });

        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            const loading = document.getElementById('loadingState');

            // Keep the create card
            const createCardHtml = container.firstElementChild.outerHTML;
            container.innerHTML = createCardHtml; // Reset but keep create button

            loading.classList.remove('hidden');
            loading.style.display = 'block';

            try {
                // Fetch events
                const result = await AdminAPI.getEvents();
                // AdminAPI returns array or object depending on implementation, handle both
                const events = Array.isArray(result) ? result : (result?.events || []);

                // Sort by date desc
                allEvents = events.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderEvents();
            } catch (e) {
                console.error("Failed to load events", e);
                container.innerHTML += `<div style="grid-column: 1/-1; text-align: center; color: var(--error-text);">Failed to load events.</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            // Reset to just Create Card
            container.innerHTML = `<div class="create-card rounded-2xl" onclick="openCreateModal()">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                        <svg data-lucide="plus" width="24"></svg>
                    </div>
                    <span style="font-weight: 600;">Create New Event</span>
                </div>`;

            const now = new Date();

            const filtered = allEvents.filter(e => {
                const eDate = new Date(e.date);
                if (filterStatus === 'upcoming') return eDate >= now;
                if (filterStatus === 'past') return eDate < now;
                return true;
            });

            if (filtered.length === 0 && filterStatus !== 'all') {
                // Show no results message
                // container.innerHTML += ... 
            }

            filtered.forEach(e => {
                const dateStr = new Date(e.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                const isUpcoming = new Date(e.date) >= now;
                const badgeColor = isUpcoming ? '#dcfce7' : '#f3f4f6';
                const badgeText = isUpcoming ? '#166534' : '#4b5563';
                const status = isUpcoming ? 'Upcoming' : 'Past';

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-image">
                       ${e.image_url
                        ? `<img src="../../backend/index.php?request=api/event/image&path=${encodeURIComponent(e.image_url)}" alt="${e.title}" onerror="this.onerror=null;this.parentElement.innerHTML='<div style=\'width:100%; height:100%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #94a3b8;\'><svg data-lucide=\'image\' width=\'32\'></svg></div>'">`
                        : `<div style="width:100%; height:100%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #94a3b8;"><svg data-lucide="image" width="32"></svg></div>`
                    }
                       <div class="event-badge" style="background: ${badgeColor}; color: ${badgeText};">${status}</div>
                    </div>
                    <div class="event-content">
                        <div class="text-xs font-bold uppercase tracking-wide text-primary mb-2">${e.type || 'Event'}</div>
                        <h3 class="font-bold text-lg text-main mb-2 truncate">${e.title}</h3>
                        <p class="text-sm text-muted mb-4 line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${e.description || 'No description provided.'}</p>
                        
                        <div style="margin-top: auto;">
                            <div class="event-meta">
                                <svg data-lucide="calendar" width="14"></svg> ${dateStr} at ${e.time || 'TBD'}
                            </div>
                            <div class="event-meta">
                                <svg data-lucide="map-pin" width="14"></svg> ${e.location || 'Online'}
                            </div>
                        </div>
                    </div>
                    <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #f9fafb;">
                        <span class="text-xs font-bold text-muted">0 registered</span>
                        <button onclick="deleteEvent('${e.id}')" style="color: #ef4444; font-size: 0.8rem; font-weight: 600; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px;">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function filterEvents(status, btn) {
            filterStatus = status;
            // Update UI tabs
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderEvents();
        }

        function handleSearch(e) {
            const q = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.event-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                if (title.includes(q)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Modal Logic
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('createModal').classList.remove('active');
            document.getElementById('createEventForm').reset();
        }

        // Create Event
        async function handleCreate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            // Validations done by required attributes
            // Image is in formData automatically

            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Publishing...';
            btn.disabled = true;

            try {
                await AdminAPI.createEvent(formData);
                Swal.fire({
                    icon: 'success',
                    title: 'Published!',
                    text: 'Event has been created successfully.',
                    timer: 1500,
                    showConfirmButton: false
                });
                closeModal();
                loadEvents();
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to create event.'
                });
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function deleteEvent(id) {
            const result = await Swal.fire({
                title: 'Delete Event?',
                text: "This cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Yes, Delete'
            });

            if (result.isConfirmed) {
                try {
                    await AdminAPI.deleteEvent(id);
                    Swal.fire('Deleted!', 'Event has been removed.', 'success');
                    loadEvents();
                } catch (e) {
                    Swal.fire('Error', 'Failed to delete event.', 'error');
                }
            }
        }
    </script>
</body>

</html>