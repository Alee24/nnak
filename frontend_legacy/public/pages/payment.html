<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renew Membership - NNAK</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-slate-50 font-inter text-slate-900">

    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="admin-sidebar fixed w-64 h-screen bg-white border-r border-gray-200 hidden lg:flex flex-col z-50">
            <!-- Brand -->
            <div class="h-20 flex items-center px-8 border-b border-gray-100 mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-[#059669] to-[#047857] rounded-xl flex items-center justify-center text-white font-bold mr-3 shadow-md">
                    N</div>
                <span class="font-bold text-lg tracking-tight text-gray-900">Member Portal</span>
            </div>

            <!-- Nav -->
            <nav class="flex-1 px-4 space-y-1">
                <a href="dashboard.html"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition">
                    <svg data-lucide="layout-grid" width="18"></svg> Dashboard
                </a>
                <a href="card.html"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition">
                    <svg data-lucide="credit-card" width="18"></svg> ID Card
                </a>
                <a href="payment.html"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-bold text-[#047857] bg-[#d1fae5] rounded-xl transition">
                    <svg data-lucide="zap" width="18"></svg> Payments
                </a>
                <a href="events.html"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition">
                    <svg data-lucide="calendar" width="18"></svg> Events
                </a>
                <a href="profile.html"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition">
                    <svg data-lucide="user" width="18"></svg> My Profile
                </a>
            </nav>

            <!-- User Footer -->
            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition cursor-pointer group">
                    <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs"
                        id="sidebarAvatar">?</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold text-gray-900 truncate" id="sidebarName">Loading...</div>
                        <div class="text-xs text-gray-500 truncate" id="sidebarEmail">...</div>
                    </div>
                    <button id="logoutBtn" class="text-gray-400 group-hover:text-red-500 transition"><svg
                            data-lucide="log-out" width="16"></svg></button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="admin-main flex-col h-screen overflow-hidden lg:ml-64 bg-slate-50 relative">

            <!-- Sticky Header -->
            <header
                class="h-20 flex justify-between items-center px-8 flex-shrink-0 bg-white/90 backdrop-blur-md border-b border-gray-100 sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <!-- Mobile Logo -->
                    <div
                        class="lg:hidden w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold">
                        N</div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">Payments & Renewal</h1>
                </div>

                <div class="flex items-center gap-3">
                    <span
                        class="hidden sm:flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-bold border border-green-100">
                        <svg data-lucide="shield-check" width="14"></svg> Secure SSL Encryption
                    </span>
                </div>
            </header>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 lg:p-10 pb-24 lg:pb-10">

                <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <!-- Left Column: Checkout Form -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                                <h2 class="text-lg font-bold text-gray-900">Subscription Renewal</h2>
                                <p class="text-sm text-gray-500">Complete your payment to activate membership.</p>
                            </div>

                            <div class="p-8">
                                <div
                                    class="flex items-center justify-between bg-green-50 p-6 rounded-xl border border-green-100 mb-8">
                                    <div>
                                        <p class="text-xs font-bold text-green-800 uppercase tracking-wide mb-1">Total
                                            Amount Due</p>
                                        <div class="text-3xl font-bold text-green-700 flex items-baseline gap-1">
                                            <span class="text-lg font-medium" id="currency">KES</span>
                                            <span id="amount">0.00</span>
                                        </div>
                                    </div>
                                    <div
                                        class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                        <svg data-lucide="credit-card" width="24"></svg>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Item Details</p>
                                    <div
                                        class="flex justify-between items-center p-4 border border-gray-200 rounded-xl bg-gray-50">
                                        <div>
                                            <div class="font-bold text-gray-900" id="membershipType">Loading Plan...
                                            </div>
                                            <div class="text-xs text-gray-500">Annual Membership Subscription</div>
                                        </div>
                                        <div class="text-right">
                                            <span
                                                class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded">1
                                                Year</span>
                                        </div>
                                    </div>
                                </div>

                                <form id="paymentForm">
                                    <div class="mb-6">
                                        <label class="block text-sm font-bold text-gray-900 mb-2">M-Pesa Phone
                                            Number</label>
                                        <div class="relative">
                                            <div
                                                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                                <svg data-lucide="smartphone" width="18"></svg>
                                            </div>
                                            <input type="tel" id="phoneNumber"
                                                class="w-full pl-10 pr-4 py-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition font-medium text-gray-900"
                                                placeholder="0712 345 678" required>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Enter the M-Pesa number to receive the
                                            payment prompt.</p>
                                    </div>

                                    <!-- Status Message -->
                                    <div id="paymentMessage" class="hidden mb-6 p-4 rounded-xl text-sm border"></div>

                                    <button type="submit"
                                        class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-200 transition flex items-center justify-center gap-2"
                                        id="payBtn">
                                        <svg data-lucide="lock" width="18"></svg> Pay Securely
                                    </button>
                                </form>

                                <p class="text-xs text-center text-gray-400 mt-6">
                                    By paying, you agree to our <a href="#" class="underline hover:text-gray-600">Terms
                                        of Service</a>. <br>
                                    Payments are processed securely via M-Pesa.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: History -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden h-full">
                            <div class="p-6 border-b border-gray-100">
                                <h3 class="font-bold text-gray-900">Payment History</h3>
                            </div>
                            <div class="p-0">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <tbody class="text-sm">
                                            <!-- Mock Data -->
                                            <tr class="border-b border-gray-50 hover:bg-gray-50">
                                                <td class="px-6 py-4">
                                                    <div class="font-bold text-gray-900">Membership 2025</div>
                                                    <div class="text-xs text-gray-500">Jan 12, 2025</div>
                                                </td>
                                                <td class="px-6 py-4 text-right">
                                                    <div class="font-bold text-gray-900">KES 2,500</div>
                                                    <span
                                                        class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700">Paid</span>
                                                </td>
                                            </tr>
                                            <tr class="border-b border-gray-50 hover:bg-gray-50">
                                                <td class="px-6 py-4">
                                                    <div class="font-bold text-gray-900">Membership 2024</div>
                                                    <div class="text-xs text-gray-500">Jan 10, 2024</div>
                                                </td>
                                                <td class="px-6 py-4 text-right">
                                                    <div class="font-bold text-gray-900">KES 2,000</div>
                                                    <span
                                                        class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700">Paid</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-6 text-center">
                                    <button class="text-sm font-bold text-green-600 hover:text-green-700">View All
                                        Transactions</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav
            class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 z-50 pb-safe">
            <a href="dashboard.html"
                class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
                <svg data-lucide="layout-grid" width="20"></svg> Home
            </a>
            <a href="card.html"
                class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
                <svg data-lucide="credit-card" width="20"></svg> ID Card
            </a>
            <a href="payment.html" class="flex flex-col items-center gap-1 text-[10px] font-bold text-green-600">
                <svg data-lucide="zap" width="20"></svg> Pay
            </a>
            <a href="profile.html"
                class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
                <svg data-lucide="user" width="20"></svg> Profile
            </a>
        </nav>
    </div>

    <script src="../js/app.js"></script>
    <script>
        lucide.createIcons();
        if (!requireAuth()) { }

        let currentMembershipTypeId = null;

        async function initPayment() {
            try {
                // 1. Get User Profile
                const profile = await AuthService.getProfile();
                const user = profile;

                // Sidebar
                document.getElementById('sidebarName').textContent = user.first_name + ' ' + user.last_name;
                document.getElementById('sidebarEmail').textContent = user.email;
                document.getElementById('sidebarAvatar').textContent = user.first_name[0];

                if (user.phone_number) {
                    document.getElementById('phoneNumber').value = user.phone_number;
                }

                // 2. Fetch all types to find the name and price
                const typesRes = await API.get('membership');
                const types = typesRes.membership_types;

                let typeToRenew = null;
                if (user.membership_type_id) {
                    typeToRenew = types.find(t => t.id == user.membership_type_id);
                }
                if (!typeToRenew && types.length > 0) {
                    typeToRenew = types[0];
                }

                if (typeToRenew) {
                    currentMembershipTypeId = typeToRenew.id;
                    document.getElementById('membershipType').textContent = typeToRenew.name + ' (Annual)';
                    document.getElementById('amount').textContent = parseFloat(typeToRenew.price).toLocaleString();
                    document.getElementById('currency').textContent = typeToRenew.currency || 'KES';
                } else {
                    document.getElementById('membershipType').textContent = 'Standard Membership';
                    document.getElementById('amount').textContent = '2,500';
                    // Fallback mock if API fails or no types
                }

            } catch (e) {
                console.error(e);
                // Fallback for demo
                document.getElementById('membershipType').textContent = 'Standard Membership';
                document.getElementById('amount').textContent = '2,500';
            }
        }

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('payBtn');
            const msg = document.getElementById('paymentMessage');
            const phone = document.getElementById('phoneNumber').value;
            const amount = document.getElementById('amount').textContent.replace(/,/g, '');

            if (!phone) return alert('Phone number is required');

            // UI Loading state
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
            msg.className = 'hidden mb-4 p-4 rounded-xl text-sm border';

            try {
                // Call Payment API
                const payload = {
                    amount: amount,
                    payment_method: 'mpesa',
                    phone_number: phone,
                    payment_type: 'membership',
                    membership_type_id: currentMembershipTypeId
                };

                const res = await API.post('payment', payload);

                if (res.success) {
                    msg.textContent = 'STK Push sent! Please check your phone.';
                    msg.className = 'block mb-6 p-4 rounded-xl text-sm bg-green-50 text-green-700 border border-green-200 font-bold';
                    btn.textContent = 'Use Phone to Complete';

                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 5000);
                }

            } catch (error) {
                console.error(error);
                msg.textContent = error.message || 'Payment initiation failed.';
                msg.className = 'block mb-6 p-4 rounded-xl text-sm bg-red-50 text-red-700 border border-red-200 font-bold';
                btn.disabled = false;
                btn.innerHTML = '<svg data-lucide="lock" width="18"></svg> Pay Securely';
                lucide.createIcons();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await AuthService.logout();
        });

        initPayment();
    </script>
</body>

</html>