<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NNAK Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS (CDN for reliability) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/styles.css">

    <style>
        /* Custom overrides */
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-dm-sans {
            font-family: 'DM Sans', sans-serif;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            border-color: #d1d5db;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e2e8f0;
            border-radius: 20px;
        }

        /* Ensure modals are hidden by default */
        .modal-hidden {
            display: none !important;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-50 text-gray-800 flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <div id="sidebar-container"></div>
    <script src="../js/sidebar.js"></script>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
        <!-- Header -->
        <header
            class="h-20 flex justify-between items-center px-8 flex-shrink-0 bg-white border-b border-gray-100 z-10 shadow-sm lg:shadow-none">
            <!-- Mobile Menu Button -->
            <button class="lg:hidden text-gray-500 hover:text-gray-700 mr-2">
                <svg data-lucide="menu" width="24"></svg>
            </button>

            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight font-dm-sans">Dashboard Overview</h1>
                <p class="text-sm text-gray-500 mt-0.5">Welcome back, Admin User</p>
            </div>
            <div class="flex items-center gap-4">
                <div
                    class="hidden md:flex items-center bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 w-64 transition focus-within:ring-2 focus-within:ring-green-100 focus-within:border-green-400">
                    <svg data-lucide="search" width="16" class="text-gray-400 mr-2"></svg>
                    <input type="text" placeholder="Search..."
                        class="bg-transparent border-none outline-none text-sm w-full text-gray-600 placeholder-gray-400">
                </div>
                <!-- User Profile -->
                <div class="flex items-center gap-4 pl-6 border-l border-gray-100 h-8">
                    <div
                        class="w-9 h-9 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 text-green-700 flex items-center justify-center font-bold text-xs ring-2 ring-white shadow-sm">
                        AU</div>
                </div>
            </div>
        </header>

        <!-- Main Body -->
        <div class="flex-1 overflow-auto custom-scrollbar">
            <div class="p-4 lg:p-8 space-y-6 lg:space-y-8">

                <!-- Welcome Banner -->
                <div
                    class="relative bg-gradient-to-br from-[#0f172a] via-[#1e293b] to-[#047857] rounded-3xl p-8 mb-8 text-white shadow-2xl shadow-emerald-900/20 overflow-hidden ring-1 ring-white/10">
                    <div
                        class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-green-500/10 to-transparent pointer-events-none">
                    </div>
                    <div class="relative z-10 max-w-2xl">
                        <h2 class="text-3xl font-bold mb-3 tracking-tight">Congratulations, Team! ðŸŽ‰</h2>
                        <p class="text-gray-300 mb-6 text-sm leading-relaxed max-w-lg">You have reached <span
                                class="text-green-400 font-bold">125%</span> of your membership growth target for
                            this
                            quarter. Check the detailed growth report for more insights.</p>
                        <button onclick="window.location.href='reports.html'"
                            class="bg-white text-[#047857] px-6 py-3 rounded-xl text-sm font-bold hover:bg-emerald-50 hover:scale-105 transition-all duration-300 shadow-lg shadow-black/10 flex items-center gap-2">
                            View Growth Report <svg data-lucide="arrow-right" width="16"></svg>
                        </button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card group hover:-translate-y-1 transition-all duration-300">
                        <div class="flex justify-between mb-4">
                            <div
                                class="p-2.5 bg-green-50 rounded-xl text-green-600 group-hover:bg-green-600 group-hover:text-white transition">
                                <svg data-lucide="dollar-sign" width="20"></svg>
                            </div>
                            <span id="badgeRevenueGrowth"
                                class="text-green-600 text-xs font-bold bg-green-50 px-2.5 py-1 rounded-full border border-green-100">--%</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 tracking-tight" id="statRevenue">--</div>
                        <div class="text-xs text-gray-500 font-medium mt-1">Total Revenue</div>
                    </div>

                    <div class="stat-card group hover:-translate-y-1 transition-all duration-300">
                        <div class="flex justify-between mb-4">
                            <div
                                class="p-2.5 bg-blue-50 rounded-xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition">
                                <svg data-lucide="users" width="20"></svg>
                            </div>
                            <span id="badgeMemberGrowth"
                                class="text-blue-600 text-xs font-bold bg-blue-50 px-2.5 py-1 rounded-full border border-blue-100">--%</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 tracking-tight" id="statTotalMembers">--</div>
                        <div class="text-xs text-gray-500 font-medium mt-1">Total Members</div>
                    </div>

                    <div class="stat-card group hover:-translate-y-1 transition-all duration-300">
                        <div class="flex justify-between mb-4">
                            <div
                                class="p-2.5 bg-orange-50 rounded-xl text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition">
                                <svg data-lucide="alert-circle" width="20"></svg>
                            </div>
                            <span
                                class="text-orange-600 text-xs font-bold bg-orange-50 px-2.5 py-1 rounded-full border border-orange-100">Action</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 tracking-tight" id="statPending">--</div>
                        <div class="text-xs text-gray-500 font-medium mt-1">Pending Dues</div>
                    </div>

                    <div class="stat-card group hover:-translate-y-1 transition-all duration-300">
                        <div class="flex justify-between mb-4">
                            <div
                                class="p-2.5 bg-purple-50 rounded-xl text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition">
                                <svg data-lucide="user-plus" width="20"></svg>
                            </div>
                            <span
                                class="text-purple-600 text-xs font-bold bg-purple-50 px-2.5 py-1 rounded-full border border-purple-100">+18%</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 tracking-tight" id="statSignups">--</div>
                        <div class="text-xs text-gray-500 font-medium mt-1">New Signups</div>
                    </div>
                </div>

                <!-- Charts & Lists -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Chart -->
                    <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-900 text-lg">Income Statistics</h3>
                            <select
                                class="bg-gray-50 border border-gray-200 text-xs font-bold text-gray-700 py-2 px-3 rounded-lg outline-none focus:ring-2 focus:ring-green-100">
                                <option>This Year</option>
                                <option>Last Year</option>
                            </select>
                        </div>
                        <div class="h-72 w-full relative">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Recent Registrations -->
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 flex flex-col h-[400px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-900 text-lg">Recent Members</h3>
                            <a href="members.html"
                                class="text-xs font-bold text-green-600 hover:text-green-700 bg-green-50 px-3 py-1.5 rounded-full transition">View
                                All</a>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar" id="recentList">
                            <!-- Loading State -->
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 gap-3">
                                <div
                                    class="w-6 h-6 border-2 border-gray-200 border-t-green-500 rounded-full animate-spin">
                                </div>
                                <span class="text-xs font-medium">Loading data...</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
    <style>
        .stat-card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #f1f5f9;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .stat-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #cbd5e1;
        }
    </style>
    <!-- Dependencies -->
    <nav
        class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 z-50 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <a href="admin.html" class="flex flex-col items-center gap-1 text-[10px] font-bold text-green-600">
            <svg data-lucide="layout-grid" width="20"></svg> Dashboard
        </a>
        <a href="members.html"
            class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
            <svg data-lucide="users" width="20"></svg> Members
        </a>
        <a href="applications.html"
            class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
            <svg data-lucide="file-check" width="20"></svg> Apps
        </a>
        <a href="settings.html"
            class="flex flex-col items-center gap-1 text-[10px] font-medium text-gray-400 hover:text-gray-900">
            <svg data-lucide="settings" width="20"></svg> Settings
        </a>
    </nav>

    <!-- Dependencies -->
    <script src="../js/app.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        lucide.createIcons();

        // Helpers
        const formatCompact = (num) => new Intl.NumberFormat('en-KE', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        const formatKES = (num) => 'KES ' + formatCompact(num);

        async function initDashboard() {
            // SAFE DATA FETCHING
            let stats = null;
            let paymentReport = null;
            let memberList = null;

            try {
                const results = await Promise.allSettled([
                    AdminAPI.getStats(),
                    AdminAPI.getAnalytics('payments'),
                    AdminAPI.getMembers(1, 10)
                ]);

                if (results[0].status === 'fulfilled') stats = results[0].value;
                if (results[1].status === 'fulfilled') paymentReport = results[1].value;
                if (results[2].status === 'fulfilled') memberList = results[2].value;

            } catch (e) {
                console.warn("Dashboard API partial failure", e);
            }

            // Mock data for demo purposes - ALWAYS GENERATE
            const mockStats = {
                total_members: Math.floor(Math.random() * (5000 - 1000) + 1000),
                year_revenue: Math.floor(Math.random() * (2500000 - 1200000) + 1200000),
                pending_amount: Math.floor(Math.random() * (500000 - 100000) + 100000),
                recent_registrations: Math.floor(Math.random() * (120 - 30) + 30),
                revenue_growth: (Math.random() * (25 - 5) + 5).toFixed(1),
                member_growth: (Math.random() * (15 - 2) + 2).toFixed(1)
            };

            // Apply mock stats for demo
            if (mockStats) {
                document.getElementById('statTotalMembers').innerText = mockStats.total_members.toLocaleString();
                document.getElementById('statRevenue').innerText = formatKES(mockStats.year_revenue);
                document.getElementById('statPending').innerText = formatKES(mockStats.pending_amount);
                document.getElementById('statSignups').innerText = mockStats.recent_registrations;

                // Growth Badges
                renderGrowthBadge('badgeRevenueGrowth', mockStats.revenue_growth);
                renderGrowthBadge('badgeMemberGrowth', mockStats.member_growth);
            }

            if (paymentReport && paymentReport.revenue_per_month) {
                renderRevenueChart(paymentReport.revenue_per_month);
            }

            if (memberList && memberList.members) {
                renderRecentList(memberList.members);
            }


        }

        function renderRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 210, 106, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 210, 106, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Revenue',
                        data: data.map(d => d.total_amount),
                        borderColor: '#00d26a',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { border: { display: false }, grid: { color: '#f1f5f9' }, ticks: { callback: v => v / 1000 + 'k', font: { size: 10 } } }
                    }
                }
            });
        }

        function renderRecentList(members) {
            const container = document.getElementById('recentList');
            container.innerHTML = members.map(m => `
                <div class="flex items-center gap-3 p-2.5 hover:bg-gray-50 rounded-xl transition group cursor-pointer border border-transparent hover:border-gray-100">
                    <div class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs font-bold uppercase flex-shrink-0 border border-gray-200">
                        ${m.first_name[0]}${m.last_name[0]}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold text-gray-900 truncate group-hover:text-green-600 transition">${m.first_name} ${m.last_name}</div>
                        <div class="text-[10px] text-gray-500 truncate">${formatDate(m.join_date)}</div>
                    </div>
                    <div class="text-[10px] font-bold ${getStatusClass(m.status)} px-2 py-0.5 rounded-full border border-opacity-20">
                        ${m.status}
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'active': return 'bg-green-50 text-green-700 border-green-200';
                case 'pending': return 'bg-yellow-50 text-yellow-700 border-yellow-200';
                default: return 'bg-gray-50 text-gray-700 border-gray-200';
            }
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        function renderGrowthBadge(id, value) {
            const el = document.getElementById(id);
            if (!el) return;

            const num = parseFloat(value || 0);
            const isPositive = num >= 0;
            const sign = isPositive ? '+' : '';

            el.innerText = `${sign}${num}%`;

            // Reset classes and apply based on value
            el.className = `text-xs font-bold px-2.5 py-1 rounded-full border ${isPositive
                ? 'text-green-600 bg-green-50 border-green-100'
                : 'text-red-600 bg-red-50 border-red-100'}`;
        }

        initDashboard();
    </script>
</body>

</html>