<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members Directory - NNAK Admin</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons & Alerts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Tailwind CSS (CDN for reliability) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/styles.css">

    <style>
        /* Custom overrides */
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-dm-sans {
            font-family: 'DM Sans', sans-serif;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            border-color: #d1d5db;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e2e8f0;
            border-radius: 20px;
        }

        /* Ensure modals are hidden by default even if Tailwind fails */
        .modal-hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-slate-50 text-gray-800 flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <!-- SIDEBAR -->
    <div id="sidebar-container"></div>
    <script src="../js/sidebar.js"></script>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">

        <!-- Header -->
        <header
            class="h-20 flex justify-between items-center px-8 flex-shrink-0 bg-white border-b border-gray-100 z-10 shadow-sm lg:shadow-none">
            <!-- Mobile Menu Button (Visible only on mobile) -->
            <button class="lg:hidden text-gray-500 hover:text-gray-700 mr-2">
                <svg data-lucide="menu" width="24"></svg>
            </button>

            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight font-dm-sans">Member Directory</h1>
                <p class="text-sm text-gray-500 mt-0.5">Manage nurses, midwives, and associates</p>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="generateMemberIds()"
                    class="hidden md:flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                    <svg data-lucide="wand-2" width="16"></svg> Generate IDs
                </button>
                <button onclick="showImportModal()"
                    class="hidden md:flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                    <svg data-lucide="upload" width="16"></svg> Import CSV
                </button>
                <button onclick="openAddMemberModal()"
                    class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-green-600/20 hover:scale-[1.02] transform transition bg-[#059669] text-white">
                    <svg data-lucide="plus" width="18"></svg> <span class="hidden md:inline">Add Member</span>
                </button>
            </div>
        </header>

        <!-- Use a scrollable container for dashboard feel -->
        <div class="flex-1 overflow-auto custom-scrollbar">
            <div class="p-8 space-y-8">

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Card 1 -->
                    <div class="summary-card p-5 rounded-2xl relative overflow-hidden group bg-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg data-lucide="users" width="64" height="64" class="text-blue-600"></svg>
                        </div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Total Members</div>
                        <div class="text-3xl font-bold text-gray-900 mb-1" id="statTotal">...</div>
                        <div class="text-xs font-medium text-blue-600 bg-blue-50 inline-block px-2 py-0.5 rounded-full">
                            All accounts</div>
                    </div>

                    <!-- Card 2 -->
                    <div class="summary-card p-5 rounded-2xl relative overflow-hidden group bg-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg data-lucide="check-circle" width="64" height="64" class="text-green-600"></svg>
                        </div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Active</div>
                        <div class="text-3xl font-bold text-gray-900 mb-1" id="statActive">...</div>
                        <div
                            class="text-xs font-medium text-green-600 bg-green-50 inline-block px-2 py-0.5 rounded-full">
                            Fully paid</div>
                    </div>

                    <!-- Card 3 -->
                    <div class="summary-card p-5 rounded-2xl relative overflow-hidden group bg-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg data-lucide="clock" width="64" height="64" class="text-yellow-600"></svg>
                        </div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pending</div>
                        <div class="text-3xl font-bold text-gray-900 mb-1" id="statPending">...</div>
                        <div
                            class="text-xs font-medium text-yellow-600 bg-yellow-50 inline-block px-2 py-0.5 rounded-full">
                            Awaiting action</div>
                    </div>

                    <!-- Card 4 -->
                    <div class="summary-card p-5 rounded-2xl relative overflow-hidden group bg-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg data-lucide="alert-octagon" width="64" height="64" class="text-red-600"></svg>
                        </div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Suspended</div>
                        <div class="text-3xl font-bold text-gray-900 mb-1" id="statSuspended">...</div>
                        <div class="text-xs font-medium text-red-600 bg-red-50 inline-block px-2 py-0.5 rounded-full">
                            Requires attention</div>
                    </div>
                </div>

                <!-- Filters & Table Section -->
                <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-1">
                    <!-- Filters Toolbar -->
                    <div
                        class="p-4 flex flex-col md:flex-row gap-4 justify-between items-center border-b border-gray-100">
                        <div class="relative w-full md:w-96 group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg data-lucide="search" width="16"
                                    class="text-gray-400 group-focus-within:text-green-500 transition"></svg>
                            </div>
                            <input type="text" id="searchInput" onkeyup="handleSearch(event)"
                                class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-green-500 focus:ring-4 focus:ring-green-500/10 transition"
                                placeholder="Search by name, email, or ID...">
                        </div>

                        <div class="flex bg-gray-100/50 p-1 rounded-xl">
                            <button onclick="filterMembers('all', this)"
                                class="segment-btn px-4 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-gray-800 transition-all">All</button>
                            <button onclick="filterMembers('active', this)"
                                class="segment-btn px-4 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-800 hover:bg-gray-200/50 transition-all">Active</button>
                            <button onclick="filterMembers('pending', this)"
                                class="segment-btn px-4 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-800 hover:bg-gray-200/50 transition-all">Pending</button>
                            <button onclick="filterMembers('suspended', this)"
                                class="segment-btn px-4 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-800 hover:bg-gray-200/50 transition-all">Suspended</button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto min-h-[400px]">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50/50 border-b border-gray-100">
                                    <th
                                        class="py-4 px-6 w-12 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox"
                                            class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    </th>
                                    <th class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Member Details</th>
                                    <th class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Register No</th>
                                    <th class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Contact</th>
                                    <th class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Status</th>
                                    <th class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider">Role
                                    </th>
                                    <th
                                        class="py-4 px-6 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody" class="divide-y divide-gray-50 text-sm">
                                <tr>
                                    <td colspan="6" class="text-center py-24">
                                        <div class="flex flex-col items-center justify-center">
                                            <div
                                                class="w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full animate-spin mb-3">
                                            </div>
                                            <span class="text-gray-400 font-medium">Loading directory...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="p-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500" id="paginationInfo">Showing 0 results</span>
                        <div class="flex items-center gap-2">
                            <button id="prevBtn"
                                class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 disabled:opacity-50">Previous</button>
                            <button id="nextBtn"
                                class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Member Modal (Normally Hidden) -->
    <!-- Added 'modal-hidden' and 'hidden' class to ensure it's not visible on load -->
    <div id="addMemberModal"
        class="modal-hidden hidden fixed inset-0 bg-gray-900/60 z-[100] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] mx-4">
            <div
                class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Add New Member</h3>
                    <p class="text-xs text-gray-500">Create a new account</p>
                </div>
                <button onclick="closeModal('addMemberModal')"
                    class="p-2 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100 transition">
                    <svg data-lucide="x" width="20"></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <form id="addMemberForm" class="space-y-6">
                    <!-- Personal Info -->
                    <div>
                        <h4
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <svg data-lucide="user" width="14"></svg> Personal Information
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">First Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="first_name" required
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Last Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="last_name" required
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Date of Birth</label>
                                <input type="date" name="date_of_birth"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Gender</label>
                                <select name="gender"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition bg-white">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="h-px bg-gray-100"></div>

                    <!-- Contact -->
                    <div>
                        <h4
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <svg data-lucide="mail" width="14"></svg> Contact Details
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Email Address <span
                                        class="text-red-500">*</span></label>
                                <input type="email" name="email" required
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Phone Number <span
                                        class="text-red-500">*</span></label>
                                <input type="tel" name="phone" required
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="col-span-2 space-y-1">
                                <label class="text-sm font-medium text-gray-700">Address</label>
                                <input type="text" name="address_line1"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                        </div>
                    </div>

                    <div class="h-px bg-gray-100"></div>

                    <!-- Professional -->
                    <div>
                        <h4
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <svg data-lucide="briefcase" width="14"></svg> Professional Info
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Occupation</label>
                                <input type="text" name="occupation"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">Organization / Hospital</label>
                                <input type="text" name="organization"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500/10 outline-none transition">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-3 bg-gray-50/50 rounded-b-2xl">
                <button onclick="closeModal('addMemberModal')"
                    class="px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-200/50 transition">Cancel</button>
                <button onclick="submitAddMember()"
                    class="px-5 py-2 rounded-lg text-sm font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-600/20 transition flex items-center gap-2">
                    <span id="submitBtnText">Create Member</span>
                    <div id="submitBtnLoader"
                        class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <!-- Debug Error Display -->
    <div id="debug-error-display" class="hidden fixed bottom-0 left-0 right-0 z-[10000] m-4 animate-fade-in"></div>

    <div id="importModal"
        class="modal-hidden hidden fixed inset-0 bg-gray-900/60 z-[100] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div
            class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[90vh] mx-4 scale-100 transform transition-transform">
            <div
                class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Import Members</h3>
                    <p class="text-xs text-gray-500">Bulk upload via CSV. <a
                            href="../assets/templates/members_template.csv" download
                            class="text-green-600 hover:underline font-medium ml-1">Download Template</a></p>
                </div>
                <button onclick="closeModal('importModal')"
                    class="p-2 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100 transition">
                    <svg data-lucide="x" width="20"></svg>
                </button>
            </div>

            <div class="p-8 text-center">
                <div id="dropZone"
                    class="border-2 border-dashed border-gray-200 rounded-2xl p-10 cursor-pointer transition-all hover:bg-green-50 hover:border-green-500 group">
                    <div
                        class="w-14 h-14 bg-green-100 text-green-700 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <svg data-lucide="file-spreadsheet" width="24"></svg>
                    </div>
                    <h4 class="text-base font-bold text-gray-900 mb-1">Click to upload CSV</h4>
                    <p class="text-xs text-gray-500">or drag and drop file here</p>
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileSelect(this)">
                </div>

                <div id="filePreview"
                    class="hidden mt-4 p-3 bg-gray-50 border border-gray-100 rounded-xl flex justify-between items-center text-sm">
                    <span id="fileName" class="font-bold text-gray-700">filename.csv</span>
                    <button onclick="clearFile()" class="text-red-500 font-bold hover:underline text-xs">Remove</button>
                </div>

                <div id="uploadProgress" class="hidden mt-6">
                    <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                        <div id="progressBar" class="bg-[#059669] h-full rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                    <div class="text-xs font-bold text-gray-500 mt-2 text-right" id="progressText">0%</div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-3 bg-gray-50/50 rounded-b-2xl">
                <button onclick="closeModal('importModal')"
                    class="px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-200/50 transition">Cancel</button>
                <button onclick="startImport()"
                    class="px-5 py-2 rounded-lg text-sm font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-600/20 transition">Start
                    Import</button>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        lucide.createIcons();

        // State
        let membersData = [];
        let currentFilter = 'all';
        let currentPage = 1;
        const itemsPerPage = 20;
        let searchQuery = '';

        document.addEventListener('DOMContentLoaded', () => {
            loadMembers();
            setupDragDrop();
        });

        async function loadMembers() {
            try {
                // Now uses authenticated fetch from AdminAPI
                const apiResult = await AdminAPI.getMembers(1, 1000, '');

                if (apiResult && apiResult.members) {
                    membersData = apiResult.members;
                } else if (Array.isArray(apiResult)) {
                    membersData = apiResult; // Fallback
                } else {
                    membersData = [];
                }

                calculateStats();
                renderTable();
            } catch (err) {
                console.error('Load members error:', err);

                // Determine error message with fallback
                let errorMessage = 'Failed to load members.';
                if (err.message) {
                    if (err.message.includes('Session expired') || err.message.includes('Authentication required')) {
                        errorMessage = 'Authentication required - Please log in';
                    } else if (err.message.includes('Failed to retrieve members')) {
                        errorMessage = 'Database error - Failed to retrieve members';
                    } else {
                        errorMessage = err.message;
                    }
                }

                // Show detailed error in table
                document.getElementById('membersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <div class="flex flex-col items-center gap-3">
                                <svg data-lucide="alert-circle" width="48" height="48" class="text-red-400"></svg>
                                <div>
                                    <div class="text-red-600 font-bold text-lg mb-1">Load Error</div>
                                    <div class="text-red-500 font-medium">${errorMessage}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();

                // Show toast notification with detailed error (only if not auth redirect)
                if (!err.message.includes('Session expired') && !err.message.includes('Authentication required')) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Load Error',
                        text: errorMessage,
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true
                    });
                }
            }
        }

        function calculateStats() {
            const total = membersData.length;
            const active = membersData.filter(m => m.status === 'active').length;
            const pending = membersData.filter(m => m.status === 'pending').length;
            const suspended = membersData.filter(m => m.status === 'suspended').length;

            // Animate numbers? For now just set text
            document.getElementById('statTotal').innerText = total;
            document.getElementById('statActive').innerText = active;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statSuspended').innerText = suspended;
        }

        function renderTable() {
            let filtered = membersData;

            if (currentFilter !== 'all') {
                filtered = filtered.filter(m => m.status === currentFilter);
            }

            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(m =>
                    (m.first_name + ' ' + m.last_name).toLowerCase().includes(q) ||
                    (m.email || '').toLowerCase().includes(q) ||
                    (m.member_id || '').toLowerCase().includes(q)
                );
            }

            // Pagination logic
            const total = filtered.length;
            const totalPages = Math.ceil(total / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filtered.slice(start, end);

            // Update Pagination Controls
            document.getElementById('paginationInfo').textContent = `Showing ${Math.min(start + 1, total)}-${Math.min(end, total)} of ${total}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;

            document.getElementById('prevBtn').onclick = () => { currentPage--; renderTable(); };
            document.getElementById('nextBtn').onclick = () => { currentPage++; renderTable(); };

            const tbody = document.getElementById('membersTableBody');

            if (total === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-20 text-gray-500 font-medium">No members match your criteria.</td></tr>`;
                return;
            }

            tbody.innerHTML = pageItems.map(m => {
                const initials = (m.first_name?.[0] || '') + (m.last_name?.[0] || '');
                const statusPill = getStatusPill(m.status);

                return `
                <tr class="group hover:bg-gray-50 transition border-b border-gray-50 last:border-none">
                     <td class="py-4 px-6 text-center">
                        <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 text-green-700 flex items-center justify-center font-bold text-xs ring-2 ring-white shadow-sm">
                                ${initials}
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-900 group-hover:text-green-700 transition">${m.first_name} ${m.last_name}</div>
                                <div class="text-[11px] text-gray-400 font-mono mt-0.5">${m.member_id || 'PENDING'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <span class="text-sm font-bold text-emerald-700 bg-emerald-50 px-2.5 py-1 rounded-lg border border-emerald-100 font-mono">${m.registration_number || 'N/A'}</span>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-sm font-medium text-gray-700">${m.email}</div>
                        <div class="text-xs text-gray-400 mt-0.5">${m.phone || '-'}</div>
                    </td>
                    <td class="py-4 px-6">
                        ${statusPill}
                    </td>
                    <td class="py-4 px-6">
                         <span class="text-sm font-medium text-gray-600 capitalize">${m.role || 'Member'}</span>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <div class="flex justify-end gap-1">
                            <button onclick="viewMemberProfile('${m.id}')" class="p-2 bg-white border border-gray-200 rounded-lg text-blue-500 hover:bg-blue-50 hover:border-blue-300 transition shadow-sm" title="View Profile">
                                <svg data-lucide="eye" width="16"></svg>
                            </button>
                            <button onclick="editMember('${m.id}')" class="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:bg-gray-100 hover:border-gray-300 transition shadow-sm" title="Edit Member">
                                <svg data-lucide="edit" width="16"></svg>
                            </button>
                            <button onclick="toggleMemberStatus('${m.id}', '${m.status}')" class="p-2 bg-white border border-gray-200 rounded-lg ${m.status === 'active' ? 'text-orange-500 hover:bg-orange-50' : 'text-green-500 hover:bg-green-50'} transition shadow-sm" title="${m.status === 'active' ? 'Suspend' : 'Activate'}">
                                <svg data-lucide="${m.status === 'active' ? 'user-x' : 'user-check'}" width="16"></svg>
                            </button>
                            <button onclick="openAwardCPDModal('${m.id}', '${m.first_name} ${m.last_name}')" class="p-2 bg-white border border-gray-200 rounded-lg text-purple-500 hover:bg-purple-50 hover:border-purple-300 transition shadow-sm" title="Award CPD Points">
                                <svg data-lucide="award" width="16"></svg>
                            </button>
                            <button onclick="openUpdateLicenseModal('${m.id}', '${m.first_name} ${m.last_name}')" class="p-2 bg-white border border-gray-200 rounded-lg text-teal-500 hover:bg-teal-50 hover:border-teal-300 transition shadow-sm" title="Update License">
                                <svg data-lucide="id-card" width="16"></svg>
                            </button>
                            <button onclick="handleDelete('${m.id}')" class="p-2 bg-white border border-gray-200 rounded-lg text-red-400 hover:text-red-600 hover:bg-red-50 hover:border-red-200 transition shadow-sm" title="Delete Member">
                                <svg data-lucide="trash-2" width="16"></svg>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function getStatusPill(status) {
            const map = {
                active: { class: 'bg-green-50 text-green-700 border-green-200', text: 'Active' },
                pending: { class: 'bg-yellow-50 text-yellow-700 border-yellow-200', text: 'Pending' },
                suspended: { class: 'bg-red-50 text-red-700 border-red-200', text: 'Suspended' },
                inactive: { class: 'bg-gray-50 text-gray-600 border-gray-200', text: 'Inactive' }
            };
            const s = (status || '').toLowerCase();
            const config = map[s] || map.inactive;

            return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-[11px] font-bold border ${config.class} uppercase tracking-wide shadow-sm">${config.text}</span>`;
        }

        // Actions
        function filterMembers(status, btn) {
            currentFilter = status;
            // Update Tab UI
            document.querySelectorAll('.segment-btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-sm', 'text-gray-800');
                b.classList.add('text-gray-500', 'hover:bg-gray-200/50', 'hover:text-gray-800');
            });

            btn.classList.remove('text-gray-500', 'hover:bg-gray-200/50', 'hover:text-gray-800');
            btn.classList.add('bg-white', 'shadow-sm', 'text-gray-800');

            currentPage = 1;
            renderTable();
        }

        function handleSearch(e) {
            searchQuery = e.target.value;
            currentPage = 1;
            renderTable();
        }

        async function handleDelete(id) {
            const result = await Swal.fire({
                title: 'Delete Member?',
                text: "This action will soft-delete the member.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Yes, Delete',
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'rounded-xl',
                    cancelButton: 'rounded-xl'
                }
            });

            if (result.isConfirmed) {
                try {
                    await AdminAPI.deleteMember(id);
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted',
                        text: 'Member has been deleted.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadMembers();
                } catch (e) {
                    Swal.fire('Error', 'Failed to delete member.', 'error');
                }
            }
        }

        // Add Member Logic - explicitly handling classes
        function openAddMemberModal() {
            const modal = document.getElementById('addMemberModal');
            modal.classList.remove('hidden', 'modal-hidden');
            document.getElementById('addMemberForm').reset();
        }

        async function submitAddMember() {
            const form = document.getElementById('addMemberForm');
            if (!form.reportValidity()) return;

            const submitBtn = document.querySelector('#addMemberModal button[onclick="submitAddMember()"]');
            const submitText = document.getElementById('submitBtnText');
            const submitLoader = document.getElementById('submitBtnLoader');

            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            // Defaults
            payload.membership_type_id = 1;

            try {
                // UI State: Loading
                submitBtn.disabled = true;
                submitText.textContent = 'Saving...';
                submitLoader.classList.remove('hidden');

                await AdminAPI.createMember(payload);

                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Member account created successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });

                closeModal('addMemberModal');
                loadMembers();

            } catch (error) {
                Swal.fire('Error', error.message || 'Failed to create member', 'error');
            } finally {
                // UI State: Reset
                submitBtn.disabled = false;
                submitText.textContent = 'Create Member';
                submitLoader.classList.add('hidden');
            }
        }

        // Import Logic
        function showImportModal() {
            const modal = document.getElementById('importModal');
            modal.classList.remove('hidden', 'modal-hidden');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('hidden', 'modal-hidden'); // Add both for safety
            if (id === 'importModal') clearFile();
        }

        let selectedFile = null;
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('filePreview').classList.remove('hidden');
            }
        }
        function clearFile() {
            selectedFile = null;
            document.getElementById('csvInput').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
        }
        function setupDragDrop() {
            const zone = document.getElementById('dropZone');
            zone.onclick = () => document.getElementById('csvInput').click();
            zone.ondragover = (e) => { e.preventDefault(); };
            zone.ondrop = (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length) handleFileSelect({ files: e.dataTransfer.files });
            };
        }

        function startImport() {
            if (!selectedFile) return Swal.fire('Error', 'Please select a CSV file', 'warning');

            document.getElementById('uploadProgress').classList.remove('hidden');
            const pBar = document.getElementById('progressBar');
            const pText = document.getElementById('progressText');

            // Client side parsing
            Papa.parse(selectedFile, {
                header: true,
                skipEmptyLines: true,
                complete: async function (results) {
                    // Send JSON to backend
                    const members = results.data;
                    pBar.style.width = '50%';
                    pText.textContent = 'Uploading data...';

                    try {
                        const res = await AdminAPI.post('/member/import', { members: members });

                        if (res.success || res.imported_count >= 0) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Import Complete',
                                text: `Imported ${res.imported_count || 0} members. ${res.errors ? res.errors.length + ' errors.' : ''}`
                            });
                            closeModal('importModal');
                            loadMembers();
                        } else {
                            throw new Error(res.error || 'Import failed');
                        }

                    } catch (e) {
                        Swal.fire('Import Error', e.message, 'error');
                        pBar.style.width = '0%';
                        document.getElementById('uploadProgress').classList.add('hidden');
                    }
                },
                error: function (err) {
                    Swal.fire('CSV Parse Error', err.message, 'error');
                }
            });
        }

    </script>

    <!-- View Member Modal -->
    <div id="viewMemberModal" class="modal-overlay hidden">
        <div class="modal-box max-w-2xl">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-900" id="profileMemberName">Member Profile</h3>
                <button onclick="closeModal('viewMemberModal')" class="text-gray-400 hover:text-gray-600 transition">
                    <svg data-lucide="x" width="20"></svg>
                </button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar" id="memberProfileContent">
                <!-- Content loaded via JS -->
                <div class="flex items-center justify-center py-12">
                    <div class="animate-spin w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Award CPD Modal -->
    <div id="awardCPDModal" class="modal-overlay hidden">
        <div class="modal-box max-w-md">
            <div
                class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 text-purple-700">
                <h3 class="font-bold flex items-center gap-2"><svg data-lucide="award" width="20"></svg> Award CPD
                    Points</h3>
                <button onclick="closeModal('awardCPDModal')" class="text-gray-400 hover:text-gray-600 transition">
                    <svg data-lucide="x" width="20"></svg>
                </button>
            </div>
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-6 font-medium uppercase tracking-wider">Member: <span
                        id="cpdMemberName" class="text-gray-900 font-bold"></span></p>
                <form id="cpdForm" class="space-y-4">
                    <input type="hidden" id="cpdMemberId">
                    <div class="form-group">
                        <label class="form-label">Points to Award</label>
                        <input type="number" id="cpdPoints" required class="form-input" placeholder="e.g. 5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Activity Type</label>
                        <select id="cpdActivityType" class="form-input">
                            <option value="Conference">Annual Conference</option>
                            <option value="Webinar">Educational Webinar</option>
                            <option value="Workshop">Skills Workshop</option>
                            <option value="Manual Award">Other Activity</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="cpdDescription" rows="2" class="form-input"
                            placeholder="Brief details..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Award Date</label>
                        <input type="date" id="cpdDate" required class="form-input">
                    </div>
                    <button type="button" onclick="submitAwardCPD()"
                        class="w-full bg-[#7c3aed] text-white py-3 rounded-xl font-bold hover:bg-[#6d28d9] transition shadow-lg shadow-purple-600/20 mt-4">
                        Confirm Award
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Update License Modal -->
    <div id="updateLicenseModal" class="modal-overlay hidden">
        <div class="modal-box max-w-md">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 text-teal-700">
                <h3 class="font-bold flex items-center gap-2"><svg data-lucide="id-card" width="20"></svg> Update
                    License Info</h3>
                <button onclick="closeModal('updateLicenseModal')" class="text-gray-400 hover:text-gray-600 transition">
                    <svg data-lucide="x" width="20"></svg>
                </button>
            </div>
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-6 font-medium uppercase tracking-wider">Member: <span
                        id="licenseMemberName" class="text-gray-900 font-bold"></span></p>
                <form id="licenseForm" class="space-y-4">
                    <input type="hidden" id="licenseMemberId">
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" id="licenseNumber" required class="form-input"
                            placeholder="e.g. NURS-2024-XXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" id="licenseExpiryDate" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Status</label>
                        <select id="licenseStatus" class="form-input">
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                            <option value="pending_renewal">Pending Renewal</option>
                        </select>
                    </div>
                    <button type="button" onclick="submitUpdateLicense()"
                        class="w-full bg-[#0d9488] text-white py-3 rounded-xl font-bold hover:bg-[#0f766e] transition shadow-lg shadow-teal-600/20 mt-4">
                        Update Information
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script src="members_actions.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>